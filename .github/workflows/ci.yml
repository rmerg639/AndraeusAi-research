# Andraeus AI - Continuous Integration
# Comprehensive CI pipeline for code quality, testing, and validation
#
# Copyright (c) 2025 Rocco Andraeus Sergi. All Rights Reserved.

name: CI

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main]
  workflow_dispatch:  # Allow manual triggers

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHONUNBUFFERED: "1"
  FORCE_COLOR: "1"

jobs:
  # ===========================================================================
  # Code Quality Checks (Fast - runs first)
  # ===========================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 flake8-docstrings flake8-bugbear

      - name: Check Black formatting
        run: black --check --diff andraeus/ tests/ evaluation/

      - name: Check isort imports
        run: isort --check-only --diff andraeus/ tests/ evaluation/

      - name: Flake8 linting
        run: |
          flake8 andraeus/ tests/ \
            --max-line-length=100 \
            --extend-ignore=E203,W503,D100,D104 \
            --per-file-ignores="__init__.py:F401,D100" \
            --statistics

  # ===========================================================================
  # Security Scanning
  # ===========================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Bandit security scan
        run: |
          bandit -r andraeus/ -ll -ii \
            --skip B101,B311 \
            -f json -o bandit-report.json || true
          bandit -r andraeus/ -ll -ii --skip B101,B311

      - name: Check dependencies for vulnerabilities
        run: |
          pip install torch transformers datasets peft trl bitsandbytes accelerate
          safety check --full-report || true
        continue-on-error: true  # Don't fail on known issues in ML deps

  # ===========================================================================
  # Unit Tests (Matrix across Python versions)
  # ===========================================================================
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: lint  # Only run tests if linting passes
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-xdist
          # Install package in editable mode (CPU-only for CI)
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install transformers datasets peft accelerate
          pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            -v \
            --cov=andraeus \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=60 \
            -x

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11'
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ===========================================================================
  # Import Verification (Ensure all modules load correctly)
  # ===========================================================================
  imports:
    name: Verify Imports
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install transformers datasets peft accelerate trl bitsandbytes
          pip install -e .

      - name: Verify core imports
        run: |
          python -c "from andraeus.core import AndraeusTrainer, AndraeusConfig; print('Core imports OK')"
          python -c "from andraeus.config import DEFAULT_MODEL_CONFIG, DEFAULT_LORA_CONFIG; print('Config imports OK')"
          python -c "from andraeus.stats_utils import check_accuracy, calculate_confidence_interval; print('Stats imports OK')"

      - name: Verify evaluation imports
        run: |
          cd evaluation
          python -c "from config_imports import BASE_MODEL, get_lora_config; print(f'BASE_MODEL: {BASE_MODEL}')"
          python -c "from config_imports import get_lora_config; cfg = get_lora_config(); print(f'LoRA r={cfg.r}')"

      - name: Syntax check all Python files
        run: |
          python -m py_compile andraeus/*.py
          python -m py_compile tests/*.py
          python -m py_compile evaluation/*.py
          echo "All Python files have valid syntax"

  # ===========================================================================
  # Documentation Build Test
  # ===========================================================================
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check README exists and is valid
        run: |
          test -f README.md && echo "README.md exists"
          # Check for broken links (basic)
          grep -o '\[.*\](http[^)]*' README.md | head -5 || true

      - name: Check essential docs exist
        run: |
          test -f LICENSE && echo "LICENSE exists"
          test -f CONTRIBUTING.md && echo "CONTRIBUTING.md exists"
          test -f pyproject.toml && echo "pyproject.toml exists"

  # ===========================================================================
  # Build Package Test
  # ===========================================================================
  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: [test, imports]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Check package
        run: twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 5

  # ===========================================================================
  # Final Status Check
  # ===========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, security, test, imports, docs, build]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "Lint failed"
            exit 1
          fi
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "Tests failed"
            exit 1
          fi
          if [[ "${{ needs.imports.result }}" != "success" ]]; then
            echo "Import verification failed"
            exit 1
          fi
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "Build failed"
            exit 1
          fi
          echo "All CI checks passed!"
